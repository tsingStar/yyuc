<!--@NO-WRAP-->
<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9"><meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>{$pname}</title>
	<link rel="stylesheet" href="/css/bootstrap.min.css">
	<link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/themes.css">
	<style type="text/css">
	.filetanble{
		width:700px;
		height:500px;
	}
	.filetanble tr,.filetanble tr th{
		vertical-align:middle;
		text-align: center;
	}
	.folders{
		width: 150px;
		height: 420px;
	}
	.btn.btn-primary.btn-curr{
		background-color: #ffffff;
		color: #333333;
	}
	.timeline-images{
	list-style: none;
	padding: 0px;
	margin: 0px;
	}
	.timeline-images li{
		list-style: none;
		float: left;
		height: 110px;
		width:132px;
		text-align: center;
		vertical-align:middle;
		padding: 0px;
		margin: 0px;
		position: relative;
	}
	.timeline-images li.curr{
		background-color: #368ee0;
		color:black;
	}
	.timeline-images li img{
		max-width: 100px;
		max-height: 90px;
		margin-top: 10px;
	}
	.timeline-images li i{
		position: absolute;
		top: 10px;
		right: 15px;
	}
	.cutpicarea img{
		margin-top:16px;
		max-width: 450px;
		max-height: 380px;
	}
	</style>
</head>

<body style="overflow: hidden;" class="{Session::get('st')}">
	<div class="container-fluid" id="content">
	<table class="table table-hover table-nomargin table-bordered filetanble">
	<tr>
	<th style="padding:2px;">文件夹</th><td rowspan="2" class="pics" style="padding:0px;margin:0px;width: 550px;height: 460px;border:none;" valign="top">
<div class="box-content nopadding" style="width: 550px;margin-top:-15px;">
	<ul class="tabs tabs-inline tabs-top">
		<li class="" style="height: 41px;overflow: hidden;background-color: #eeeeee;width:337px;" title="可修改文件夹名称方便管理">
			<a href="javascript:;" data-toggle="tab" style="background-color: #eeeeee;"><i class="icon-tag"></i>文件夹：
			<input type="text" class="input-large" id="picfoldername" data-original-title="Apply filter" style="margin: 0px;padding:0px;width:207px;background-color: #eeeeee;"/>
			</a>
		</li>
		<li class="active tabsli" style="height: 41px;width: 105px;">
			<a href="javascript:;" data-toggle="tab" id="taboneack" onclick="$('.tabsli').removeClass('active');$(this).parent().addClass('active');$('#tab2').hide();$('#tab1').show();"><i class="icon-inbox"></i>图片文件</a>
		</li>
		<li class="tabsli" style="height: 41px;width: 105px;">
			<a href="javascript:;" data-toggle="tab" onclick="$('.tabsli').removeClass('active');$(this).parent().addClass('active');$('#tab1').hide();$('#tab2').show();" style="padding-left: 10px;padding-right:10px;"><i class="glyphicon-crop"></i>上传后剪裁</a>
		</li>
	</ul>
	<div class="tab-content padding tab-content-inline tab-content-bottom"  style="height:440px;padding: 0px;">
		<div class="tab-pane active" id="tab1" style="width: 100%;height:100%;">
		<div id="imgareas" style="width: 100%;height:400px;overflow:auto;">
		<ul class="timeline-images" id="imgulareas">
				
		</ul>	
		</div>
		<div style="width: 100%;height: 40px;text-align: center;overflow: hidden;">
		<table style="border:none;padding:0;margin:0;width:250px;height:30px;margin-left: 300px;margin-top: -8px;">
		<tr style="border:none;padding:0;margin:0;width:auto;height:30px;">
		<td style="border:none;padding:0;margin:0;width:auto;height:30px;" valign="top">
		<button class="btn btn-primary" style="vertical-align:top;" onclick="selectpic();"><i class="glyphicon-ok"></i>&nbsp;确定选择</button>
		</td>
		<td style="border:none;padding:0;margin:0;width:auto;height:30px;" valign="top">
		<button class="btn btn-inverse" style="vertical-align:top;" onclick="removepic();"><i class="glyphicon-remove"></i>&nbsp;删除</button>
		</td>
		<td style="border:none;padding:0;margin:0;width:auto;height:30px;padding-top:10px;" valign="top">
		{$m->upload('pic1',array('size'=>10240,'onselect'=>'picseled','width'=>64,'height'=>30,'class'=>'btn btn-success','type'=>'jpg,gif,png,jpeg','text'=>'<i class="glyphicon-inbox_out"></i>上传','onsuccess'=>'newpicok'),null,'images8upload.html')}
		</td>
		</tr>
		</table>		
		</div>		
		</div>
		<div class="tab-pane" id="tab2" style="height:440px;padding: 0px;text-align:center;">
			<div style="width:550px;min-height:200px;text-align:center;" class="cutpicarea" >
			<div id="cutpicarea" style="width: auto;text-align: center;"></div>
			</div>
			<div style="width: 100%;text-align:center;">
			{$m->upload('pic2',array('size'=>10240,'onselect'=>'picseled','width'=>124,'height'=>30,'class'=>'btn btn-success','type'=>'jpg,gif,png,jpeg','text'=>'<i class="glyphicon-inbox_out"></i>上传并剪裁','onsuccess'=>'hideup'),null,'images8upload.html','cutpicarea',array('buttonText'=>'<i class="glyphicon-scissors"></i>&nbsp;完成剪裁','onsuccess'=>'newpicok','buttonClass'=>'btn btn-primary'))}
			</div>
		</div>
	</div>
</div>

	</td>
	</tr>
	<tr>
	<td style="padding: 0px;vertical-align: top;" valign="top">
	<div class="folders" style="margin: 0px;height:440px;padding:0px;">
	{loop 10}
	{_ $fn = 'f'.($__i-1);}
	<button class="btn btn-primary fordersbtn" rel="{$fn}" style="width: 150px;padding: 12px;overflow: hidden;height:44px;white-space: nowrap;text-align: left;display: block;">
	<i class="icon-folder-close"></i><span style="margin-left: 5px;">{$image->$fn}</span>
	</button>
	{/loop}
	</div>
	</td>
	</tr>
	</table>
	</div>
	<script type="text/javascript">
	$(function(){
		$('.fordersbtn').click(function(){
			$('.icon-folder-open').removeClass('icon-folder-open').addClass('icon-folder-close');
			$(this).children('i').removeClass('icon-folder-close').addClass('icon-folder-open');
			$('.fordersbtn').removeClass('btn-curr');
			$(this).addClass('btn-curr');
			//设置文件夹名称
			$('#picfoldername').val($.trim($(this).text()));
			//当前文件夹
			window.fnrel = $(this).attr('rel');
			//加载图片
			
			$('#imgulareas').empty();
			if(!window[window.fnrel]){
				_.loading('文件获取中...');
				_.ajax('images8list-'+window.fnrel+'.html',null,function(m){
					var pre = m.pp;
					var i=0;
					for(var n in m){
						if(n=='pp'){
							continue;
						}
						
						if(i<16){
							$('#imgulareas').append('<li><img src="'+pre+n+'" relnum="'+m[n]+'" title="'+getpiccname(pre+n)+'"></li>');
						}else{
							$('#imgulareas').append('<li><img osrc="'+pre+n+'" src="/@system/img/load.gif" title="'+getpiccname(pre+n)+'" relnum="'+m[n]+'"></li>');
						}						
						i++;
					}
					window[window.fnrel] = ' '+$('#imgulareas').html();
					_.loading(false);
				});
			}else{
				$('#imgulareas').html(window[window.fnrel]);
			}		
		});
		$('.fordersbtn[rel="{$initfn}"]').trigger('click');
		$('#picfoldername').on('keyup click mouseup mousedown',function(){
			$('.icon-folder-open').next('span').text($(this).val());
		});
		$('#picfoldername').on('blur',function(){
			$('.icon-folder-open').next('span').text($(this).val());
			var fn = $('.icon-folder-open').parent().attr('rel');
			_.ajax('images8changefn.html',{ fn:fn,val:$(this).val()},function(m){ });
		});
		$('#imgareas').scroll(notifyimg);
		
		if(window.parent.picsetimg != 'more'){
			$('#imgareas').delegate('img','click',function(){
				$('#imgareas').find('li.curr').removeClass('curr');
				$(this).parent().addClass('curr');	
			});
			$('#imgareas').delegate('img','dblclick',function(){
				setpic($(this).attr('src'));
			});
		}else{
			$('#imgareas').delegate('img','click',function(){
				if($(this).parent().is('.curr')){
					$(this).parent().removeClass('curr');
				}else{
					$(this).parent().addClass('curr');
				}				
			});
		}
	});
	
	
	//图片选择后的操作 用于增加其他参数
	function picseled(fn,fm){
		$('#appdenfnnum').remove();
		fm.append('<input type="hidden" name="fnrel" id="appdenfnnum" value="'+window.fnrel+'"/>');
		return true;
	}
	
	function removepic(){
		var tli = $('#imgareas').find('li.curr');
		var timg = tli.find('img');
		var pn = timg.attr('src');
		var fn = window.fnrel;
		var num = parseInt(timg.attr('relnum'));
		if(num >0 && !confirm('该图片被引用'+num+'次，确定要删除吗？')){
			return;
		}
		
		_.ajax('images8del.html',{ fn:fn,pn:pn},function(m){
			if(m=='ok'){
				tli.remove();
				notifyimg();
			}
		});
	}
	
	//展示图片
	function notifyimg(){
		$('img[osrc]').each(function(){
			if($(this).position().top-$('#imgulareas').scrollTop()<450){
				$(this).attr('src',$(this).attr('osrc'));
				$(this).removeAttr('osrc');
			}
		});
	}
	function selectpic(){
		if(window.parent.picsetimg != 'more'){
			var url = $('#imgareas').find('li.curr').find('img').attr('src');
			setpic(url);
		}else{
			var imgs = [];
			$('#imgareas').find('li.curr').each(function(){
				var url = $(this).find('img').attr('src');
				imgs[imgs.length] = [url,getpiccname(url)];
			});
			if(window.parent.picsetbak){				
				window.parent.picsetbak(imgs);
			}
			window.parent.layer.close(window.parent.picsetpopdiv);
		}
		
	}
	function hideup(url,f){
		f.css('opacity',0);
		window.cutform = f;
	}
	function showup(url,f){
		window.cutform.css('opacity',1);
	}
	function newpicok(url){
		if(window.parent.picsetimg != 'more'){
			setpic(url);
		}else{
			$('#imgulareas').prepend('<li><img src="'+url+'" relnum="0" title="'+getpiccname(url)+'"></li>');
			showup();
			$('#cutpicarea').empty();
			$('#taboneack').trigger('click');
		}
		
	}
	function setpic(url){
		if(window.parent.picsetimg){
			window.parent.picsetimg.attr('src',url);
			window.parent.picsetimg = null;
		}
		if(window.parent.picsetinput){
			window.parent.picsetinput.val(url);
			window.parent.picsetinput = null;
		}
		
		if(window.parent.picsetbak){
			
			window.parent.picsetbak(url,getpiccname(url));
			window.parent.picsetbak = null;
		}
		window.parent.layer.close(window.parent.picsetpopdiv);
	}
	function getpiccname(url){
		var beginIndex = url.lastIndexOf ('_');
		var endIndex = url.lastIndexOf ('.');
		var name = url.substring(beginIndex+1,endIndex);
		name = name.replaceAll('ITI@I','/');
		return utf8to16(base64decode(name));
	}
		var base64EncodeChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";  
		var base64DecodeChars = new Array(  
		　　-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  
		　　-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  
		　　-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 62, -1, -1, -1, 63,  
		　　52, 53, 54, 55, 56, 57, 58, 59, 60, 61, -1, -1, -1, -1, -1, -1,  
		　　-1,　0,　1,　2,　3,  4,　5,　6,　7,　8,　9, 10, 11, 12, 13, 14,  
		　　15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, -1, -1, -1, -1, -1,  
		　　-1, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,  
		　　41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, -1, -1, -1, -1, -1);  
		function base64encode(str) {  
		　　var out, i, len;  
		　　var c1, c2, c3;  
		　　len = str.length;  
		　　i = 0;  
		　　out = "";  
		　　while(i < len) {  
		 c1 = str.charCodeAt(i++) & 0xff;  
		 if(i == len)  
		 {  
		　　 out += base64EncodeChars.charAt(c1 >> 2);  
		　　 out += base64EncodeChars.charAt((c1 & 0x3) << 4);  
		　　 out += "==";  
		　　 break;  
		 }  
		 c2 = str.charCodeAt(i++);  
		 if(i == len)  
		 {  
		　　 out += base64EncodeChars.charAt(c1 >> 2);  
		　　 out += base64EncodeChars.charAt(((c1 & 0x3)<< 4) | ((c2 & 0xF0) >> 4));  
		　　 out += base64EncodeChars.charAt((c2 & 0xF) << 2);  
		　　 out += "=";  
		　　 break;  
		 }  
		 c3 = str.charCodeAt(i++);  
		 out += base64EncodeChars.charAt(c1 >> 2);  
		 out += base64EncodeChars.charAt(((c1 & 0x3)<< 4) | ((c2 & 0xF0) >> 4));  
		 out += base64EncodeChars.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >>6));  
		 out += base64EncodeChars.charAt(c3 & 0x3F);  
		　　}  
		　　return out;  
		}  
		function base64decode(str) {  
		　　var c1, c2, c3, c4;  
		　　var i, len, out;  
		　　len = str.length;  
		　　i = 0;  
		　　out = "";  
		　　while(i < len) {  
		 /* c1 */  
		 do {  
		　　 c1 = base64DecodeChars[str.charCodeAt(i++) & 0xff];  
		 } while(i < len && c1 == -1);  
		 if(c1 == -1)  
		　　 break;  
		 /* c2 */  
		 do {  
		　　 c2 = base64DecodeChars[str.charCodeAt(i++) & 0xff];  
		 } while(i < len && c2 == -1);  
		 if(c2 == -1)  
		　　 break;  
		 out += String.fromCharCode((c1 << 2) | ((c2 & 0x30) >> 4));  
		 /* c3 */  
		 do {  
		　　 c3 = str.charCodeAt(i++) & 0xff;  
		　　 if(c3 == 61)  
		　return out;  
		　　 c3 = base64DecodeChars[c3];  
		 } while(i < len && c3 == -1);  
		 if(c3 == -1)  
		　　 break;  
		 out += String.fromCharCode(((c2 & 0XF) << 4) | ((c3 & 0x3C) >> 2));  
		 /* c4 */  
		 do {  
		　　 c4 = str.charCodeAt(i++) & 0xff;  
		　　 if(c4 == 61)  
		　return out;  
		　　 c4 = base64DecodeChars[c4];  
		 } while(i < len && c4 == -1);  
		 if(c4 == -1)  
		　　 break;  
		 out += String.fromCharCode(((c3 & 0x03) << 6) | c4);  
		　　}  
		　　return out;  
		}  
		function utf16to8(str) {  
		　　var out, i, len, c;  
		　　out = "";  
		　　len = str.length;  
		　　for(i = 0; i < len; i++) {  
		 c = str.charCodeAt(i);  
		 if ((c >= 0x0001) && (c <= 0x007F)) {  
		　　 out += str.charAt(i);  
		 } else if (c > 0x07FF) {  
		　　 out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));  
		　　 out += String.fromCharCode(0x80 | ((c >>　6) & 0x3F));  
		　　 out += String.fromCharCode(0x80 | ((c >>　0) & 0x3F));  
		 } else {  
		　　 out += String.fromCharCode(0xC0 | ((c >>　6) & 0x1F));  
		　　 out += String.fromCharCode(0x80 | ((c >>　0) & 0x3F));  
		 }  
		　　}  
		　　return out;  
		}  
		function utf8to16(str) {  
		　　var out, i, len, c;  
		　　var char2, char3;  
		　　out = "";  
		　　len = str.length;  
		　　i = 0;  
		　　while(i < len) {  
		 c = str.charCodeAt(i++);  
		 switch(c >> 4)  
		 {  
		　 case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:  
		　　 // 0xxxxxxx  
		　　 out += str.charAt(i-1);  
		　　 break;  
		　 case 12: case 13:  
		　　 // 110x xxxx　 10xx xxxx  
		　　 char2 = str.charCodeAt(i++);  
		　　 out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));  
		　　 break;  
		　 case 14:  
		　　 // 1110 xxxx　10xx xxxx　10xx xxxx  
		　　 char2 = str.charCodeAt(i++);  
		　　 char3 = str.charCodeAt(i++);  
		　　 out += String.fromCharCode(((c & 0x0F) << 12) |  
		　　　　((char2 & 0x3F) << 6) |  
		　　　　((char3 & 0x3F) << 0));  
		　　 break;  
		 }  
		　　}  
		　　return out;  
		}  
	</script>
</body>
</html>

